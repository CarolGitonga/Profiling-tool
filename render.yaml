services:
  # ------------------------
  # Django Web Service
  # ------------------------
  - type: web
    name: people-profiling-web
    env: python

    buildCommand: >
      pip install -r requirements.txt &&
      mkdir -p /opt/render/project/src/.playwright &&
      PLAYWRIGHT_BROWSERS_PATH=/opt/render/project/src/.playwright python -m playwright install chromium &&
      python manage.py collectstatic --noinput &&
      python manage.py migrate

    startCommand: gunicorn people_profiling.wsgi:application --preload --workers=4 --threads=2 --timeout 120
    autoDeploy: true

    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: profiling.settings.production
      - key: PYTHON_VERSION
        value: 3.11
      - key: DATABASE_URL
        fromDatabase:
          name: people-profiling-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: people-profiling-redis
          property: connectionString
      - key: SECRET_KEY
        sync: false # set manually in dashboard
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: "people-profiling.onrender.com"
      # Cloudinary
      - key: CLOUDINARY_URL
        sync: false # paste your Cloudinary URL manually
      - key: PLAYWRIGHT_BROWSERS_PATH
        value: /opt/render/project/src/.playwright

    # ------------------------
    # Serve static + media files
    # ------------------------
    staticPublishPath: staticfiles

    routes:
      # Serve static assets
      - type: rewrite
        source: /static/(.*)
        destination: /opt/render/project/src/staticfiles/$1

      # âœ… Serve uploaded / generated media files (graphs, wordclouds, etc.)
      - type: rewrite
        source: /media/(.*)
        destination: /opt/render/project/src/media/$1

  # ------------------------
  # Celery Worker
  # ------------------------
  - type: worker
    name: people-profiling-worker
    env: python
    plan: starter
    buildCommand: |
      pip install -r requirements.txt &&
      mkdir -p /opt/render/project/src/.playwright &&
      PLAYWRIGHT_BROWSERS_PATH=/opt/render/project/src/.playwright python -m playwright install chromium
    startCommand: "celery -A people_profiling worker -l info -Q default,instagram,tiktok,twitter"

    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: profiling.settings.production
      - key: DATABASE_URL
        fromDatabase:
          name: people-profiling-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: people-profiling-redis
          property: connectionString
      - key: SECRET_KEY
        sync: false
      - key: DEBUG
        value: "False"
      - key: CLOUDINARY_URL
        sync: false
      - key: PLAYWRIGHT_BROWSERS_PATH
        value: /opt/render/project/src/.playwright

# ------------------------
# PostgreSQL Database
# ------------------------
databases:
  - name: people-profiling-db
    databaseName: peopleprofiling
    user: profilinguser

# ------------------------
# Redis Instance
# ------------------------
- type: redis
  name: people-profiling-redis
  ipAllowList: [] # empty list = allow only internal connections
