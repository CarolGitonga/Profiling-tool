services:
  # Django Web Service
  - type: web
    name: people-profiling-web
    env: python
    buildCommand: >
      pip install -r requirements.txt &&
      python manage.py collectstatic --noinput &&
      python manage.py migrate
    startCommand: >
      gunicorn profiling.wsgi:application
      --preload --workers=4 --threads=2 --timeout 120
    autoDeploy: true
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: profiling.settings.production
      - key: PYTHON_VERSION
        value: 3.11
      - key: DATABASE_URL
        fromDatabase:
          name: people-profiling-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: people-profiling-redis
          property: connectionString
      - key: SECRET_KEY
        sync: false # set manually in dashboard
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: "people-profiling.onrender.com"
      # Cloudinary
      - key: CLOUDINARY_URL
        sync: false # paste your Cloudinary URL here manually

  # Celery Worker
  - type: worker
    name: people-profiling-worker
    env: python
    buildCommand: "pip install -r requirements.txt"
    startCommand: "celery -A people_profiling worker -l info"
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: profiling.settings.production
      - key: DATABASE_URL
        fromDatabase:
          name: people-profiling-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: people-profiling-redis
          property: connectionString
      - key: SECRET_KEY
        sync: false
      - key: DEBUG
        value: "False"
      - key: CLOUDINARY_URL
        sync: false

databases:
  # Postgres Database
  - name: people-profiling-db
    databaseName: peopleprofiling
    user: profilinguser

# ------------------------
# Redis Instance
# ------------------------
- type: redis
  name: people-profiling-redis
  ipAllowList: [] # empty list = allow only internal connections
