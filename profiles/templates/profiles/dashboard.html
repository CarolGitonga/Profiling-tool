{% extends "pages/base.html" %}
{% load profile_extras %}

{% block title %}User Profile Dashboard{% endblock %}
{% block content %}

<style>
    body {
        background-color: #f8f9fa;
    }
    .profile-header {
        background: linear-gradient(135deg, #0d6efd, #6f42c1);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        text-align: center;
    }
    .profile-header img {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
        border: 4px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        transition: transform 0.2s ease;
    }
    .card:hover {
        transform: translateY(-4px);
    }
    .badge-stat {
        font-size: 0.9rem;
        padding: 0.6rem 0.9rem;
        margin: 0.3rem;
        border-radius: 20px;
    }
    .remove-btn {
        margin-top: 1rem;
    }
    .section-title {
        font-weight: 600;
        font-size: 1.3rem;
        margin-bottom: 1rem;
        color: #495057;
    }
</style>

<div class="container py-4">

{% if profiles %}
    <!-- Profile Header -->
    <div class="profile-header mx-auto" style="max-width: 650px;">
        {% if profiles.0.avatar_url %}
            <img src="{{ profiles.0.avatar_url }}" alt="User Avatar">
        {% else %}
            <img src="https://via.placeholder.com/140" alt="No Avatar">
        {% endif %}
        <h2 class="fw-bold">Dashboard for {{ profiles.0.username }}</h2>
    </div>

       <!-- 🔁 Auto-Refresh Notice -->
    {% if not profiles.0.full_name and not profiles.0.socialmediaaccount_set.exists %}
        <div class="alert alert-info text-center mt-3">
            <i class="bi bi-hourglass-split"></i>
            Profile data is still being scraped. This page will refresh automatically every 10 seconds...
        </div>

        <script>
            // 🔁 Auto-refresh every 10 seconds while scraping is incomplete
            setTimeout(() => location.reload(), 10000);
        </script>
    {% endif %}

 


    <!-- Platform Cards -->
    <div class="row justify-content-center mt-4">
        <h3 class="section-title text-center">Profile Details</h3>
        {% for profile in profiles %}
        <div class="col-md-6 col-lg-5">
            <div class="card p-4">
                <h5 class="fw-bold text-primary"><i class="bi bi-person-badge"></i> {{ profile.platform }} Profile</h5>
                <hr>
                <p><strong>Full Name:</strong> {{ profile.full_name|default:"Not available" }}</p>

                {% with accounts|get_account_for:profile as account %}
                    {% if profile.platform == 'GitHub' and account %}
                        <!-- GitHub details -->
                        <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
                        <div>
                            <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
                            <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
                            <span class="badge bg-success badge-stat">Repos: {{ account.public_repos }}</span>
                        </div>
                        <p class="mt-3"><strong>Company:</strong> {{ profile.company|default:"Not specified" }}</p>
                        <p><strong>Location:</strong> {{ profile.location|default:"Not specified" }}</p>
                        <p><strong>Website:</strong> 
                            {% if profile.blog %}
                                <a href="{{ profile.blog }}" target="_blank">{{ profile.blog }}</a>
                            {% else %}
                                Not specified
                            {% endif %}
                        </p>
                        <p><strong>GitHub Joined:</strong> {{ profile.github_created_at|date:"F Y" }}</p>
                        <!-- 🔗 Behavioral Dashboard link -->
    <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}"
       class="btn btn-outline-info btn-sm mt-3">
        <i class="bi bi-graph-up"></i> View Behavioral Dashboard
    </a>
                    {% elif profile.platform == 'Twitter' and account %}
                        <!-- Twitter details -->
                        <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
                        <div>
                            <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
                            <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
                        </div>
                        <p class="mt-3"><strong>Verified:</strong> {{ profile.verified|yesno:"Yes,No" }}</p>
                        <p><strong>Location:</strong> {{ profile.location|default:"Not specified" }}</p>
                        <p><strong>Twitter Joined:</strong> {{ profile.profile_created_at|date:"F Y" }}</p>
                        <!-- 🔗 Behavioral Dashboard link -->
    <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}"
       class="btn btn-outline-info btn-sm mt-3">
        <i class="bi bi-graph-up"></i> View Behavioral Dashboard
    </a>
                    {% elif profile.platform == 'Instagram' and account %}
                        <!-- Instagram details -->
                        <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
                        <div>
                            <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
                            <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
                            <span class="badge bg-success badge-stat">Posts: {{ account.posts_collected }}</span>
                        </div>
                        <p class="mt-3"><strong>Verified:</strong> {{ account.is_verified|yesno:"Yes,No" }}</p>
                         <!-- 🔗 Behavioral Dashboard link -->
    <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}"
       class="btn btn-outline-info btn-sm mt-3">
        <i class="bi bi-graph-up"></i> View Behavioral Dashboard
    </a>
                    {% elif profile.platform == 'TikTok' and account %}
                        <!-- TikTok details -->
                        <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
                        <div>
                            <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
                            <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
                            <span class="badge bg-success badge-stat">Videos: {{ account.videos }}</span>
                            <span class="badge bg-warning badge-stat">Likes: {{ account.hearts }}</span>
                        </div>
                        <!-- 🔗 Behavioral Dashboard link -->
    <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}"
       class="btn btn-outline-info btn-sm mt-3">
        <i class="bi bi-graph-up"></i> View Behavioral Dashboard
    </a>
                    {% elif profile.platform == 'Sherlock' %}
                        <!-- Sherlock results -->
                        <h5 class="mt-3 text-primary"><i class="bi bi-search"></i> Sherlock Results</h5>
                        {% if request.session.sherlock_results %}
                            <div class="d-flex flex-wrap gap-2 mt-3 justify-content-center">
                                {% for result in request.session.sherlock_results %}
                                    <a href="{{ result.url }}" target="_blank" class="badge bg-dark text-decoration-none p-2">
                                        {{ result.platform }}
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted mt-3"><em>No Sherlock results available yet.</em></p>
                        {% endif %}
                    {% endif %}
                {% endwith %}

                <p class="text-muted mt-3 small">
                    <i class="bi bi-clock-history"></i> Profiled {{ profile.date_profiled|timesince }} ago
                </p>
            </div>
        </div>
        {% endfor %}
    </div>

      <!-- Analytics Section -->
<div class="row g-4">
    <!-- Word Cloud -->
    {% if wordcloud_image %}
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white fw-bold text-center py-2">
                <i class="bi bi-cloud"></i> Word Cloud
            </div>
            <div class="card-body d-flex justify-content-center align-items-center" 
                 style="min-height: 180px; background: #f9fafc;">
                <img src="data:image/png;base64,{{ wordcloud_image }}" 
                     alt="Word Cloud" 
                     class="img-fluid rounded border p-1 shadow-sm"
                     style="max-height: 180px; object-fit: contain;">
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Pie Chart -->
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-success text-white fw-bold text-center py-2">
                <i class="bi bi-pie-chart"></i> Platforms
            </div>
            <div class="card-body p-2">
                <canvas id="platformChart" height="180"></canvas>
            </div>
        </div>
    </div>

    <!-- Bar Chart -->
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white fw-bold text-center py-2">
                <i class="bi bi-bar-chart"></i> Followers
            </div>
            <div class="card-body p-2">
                <canvas id="followersBarChart" height="180"></canvas>
            </div>
        </div>
    </div>

    <!-- Line Chart -->
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-warning text-dark fw-bold text-center py-2">
                <i class="bi bi-graph-up"></i> Growth
            </div>
            <div class="card-body p-2">
                <canvas id="growthLineChart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

{% else %}
    <div class="alert alert-warning text-center">No profiles found for this user.</div>
{% endif %}

<a href="{% url 'search_profile' %}" class="btn btn-outline-secondary mt-4">
    <i class="bi bi-arrow-left"></i> Back to Search
</a>
<a href="{% url 'profile_activity' profiles.0.pk %}" class="btn btn-primary mt-3">
  <i class="bi bi-graph-up"></i> View Activity
</a>


</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Pie Chart
  const ctx = document.getElementById("platformChart").getContext("2d");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        data: {{ chart_data|safe }},
        backgroundColor: [
          "#0d6efd", "#6f42c1", "#198754", "#dc3545", "#fd7e14", "#20c997"
        ],
      }]
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } }
  });

  // Bar Chart
  const barCtx = document.getElementById("followersBarChart").getContext("2d");
  new Chart(barCtx, {
    type: "bar",
    data: {
      labels: {{ bar_labels|safe }},
      datasets: [{
        label: "Followers",
        data: {{ bar_data|safe }},
        backgroundColor: ["#1DA1F2", "#E1306C", "#69C9D0", "#333"],
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  // Line Chart
  const growthCtx = document.getElementById("growthLineChart").getContext("2d");
  new Chart(growthCtx, {
    type: "line",
    data: {
      labels: {{ growth_labels|safe }},
      datasets: [{
        label: "Profiles Collected",
        data: {{ growth_data|safe }},
        fill: false,
        borderColor: "#0d6efd",
        tension: 0.3,
        pointBackgroundColor: "#0d6efd"
      }]
    },
    options: { responsive: true, plugins: { legend: { position: "top" } } }
  });
</script>
{% endblock %}
