{% extends "pages/base.html" %}
{% load profile_extras %}

{% block title %}Dashboard | People Profiling{% endblock %}
{% block content %}

<style>
  body {
    background-color: #fdffff;
    font-family: 'Roboto', sans-serif;
  }

  /* Header */
  .profile-header {
    background: linear-gradient(135deg, #22267c, #3439a7);
    color: #fff;
    text-align: center;
    padding: 3rem 1rem;
    border-radius: 20px;
    margin-bottom: 2.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  .profile-header img {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    border: 5px solid #fff;
    object-fit: cover;
    margin-bottom: 1rem;
  }

  .section-title {
    font-weight: 700;
    color: #22267c;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  /* Cards */
  .card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    transition: transform 0.25s ease;
  }

  .card:hover {
    transform: translateY(-5px);
  }

  /* Badges */
  .badge-stat {
    font-size: 0.9rem;
    padding: 0.6rem 0.9rem;
    border-radius: 30px;
    margin: 0.25rem;
  }

  /* Buttons */
  .btn-outline-info {
    border-color: #22267c;
    color: #22267c;
  }

  .btn-outline-info:hover {
    background-color: #22267c;
    color: #fff;
  }

  /* Sherlock Results */
  .result-pill {
    display: inline-flex;
    align-items: center;
    background: #22267c;
    color: #fff;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
  }

  .result-pill:hover {
    background: #f6c100;
    color: #222;
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  }
</style>

<div class="container py-5">

  {% if profiles %}
  <!-- Header -->
  <div class="profile-header mx-auto" style="max-width: 680px;">
    <img src="{{ profiles.0.avatar_url|default:'https://via.placeholder.com/130' }}" alt="User Avatar">
    <h2 class="fw-bold mb-1">{{ profiles.0.username }}</h2>
    <p class="text-light mb-0">Multi-platform social insights and behavioral analysis</p>
  </div>

  {% if not profiles.0.full_name and not profiles.0.socialmediaaccount_set.exists %}
  <div class="alert alert-info text-center mt-3 shadow-sm">
    <i class="bi bi-hourglass-split"></i>
    Data is being collected. Refreshing every 10 seconds...
  </div>
  <script>setTimeout(() => location.reload(), 10000);</script>
  {% endif %}

  <!-- Profile Details -->
  <h3 class="section-title">Profile Details</h3>
  <div class="row justify-content-center g-4">
    {% for profile in profiles %}
    <div class="col-md-6 col-lg-5">
      <div class="card p-4 h-100">
        <h5 class="fw-bold text-primary mb-2">
          <i class="bi bi-person-badge"></i> {{ profile.platform }} Profile
        </h5>
        <hr>

        {% with accounts|get_account_for:profile as account %}
        {% if account %}
          <p><strong>Full Name:</strong> {{ profile.full_name|default:"Not available" }}</p>
          <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>

          {% if profile.platform == "GitHub" %}
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
              <span class="badge bg-success badge-stat">Repos: {{ account.public_repos }}</span>
            </div>
            <p class="mt-3"><strong>Company:</strong> {{ profile.company|default:"Not specified" }}</p>
            <p><strong>Location:</strong> {{ profile.location|default:"Not specified" }}</p>

          {% elif profile.platform == "Twitter" %}
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
            </div>
            <p class="mt-3"><strong>Verified:</strong> {{ profile.verified|yesno:"Yes,No" }}</p>
            <p><strong>Joined:</strong> {{ profile.profile_created_at|date:"F Y" }}</p>

          {% elif profile.platform == "Instagram" %}
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
              <span class="badge bg-success badge-stat">Posts: {{ account.posts_collected }}</span>
            </div>

          {% elif profile.platform == "TikTok" %}
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
              <span class="badge bg-warning badge-stat">Videos: {{ account.posts_collected }}</span>
            </div>

          {% elif profile.platform == "Sherlock" %}
            <h6 class="mt-3 text-primary"><i class="bi bi-search"></i> Results Found</h6>
            {% if request.session.sherlock_results %}
            <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
              {% for result in request.session.sherlock_results %}
              <a href="{{ result.url }}" target="_blank" class="result-pill">
                <i class="bi bi-link-45deg me-1"></i> {{ result.platform }}
              </a>
              {% endfor %}
            </div>
            {% else %}
              <p class="text-muted mt-3"><em>No results available yet.</em></p>
            {% endif %}
          {% endif %}

          <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}" class="btn btn-outline-info btn-sm mt-3">
            <i class="bi bi-graph-up"></i> View Behavioral Dashboard
          </a>
        {% else %}
          <p class="text-muted"><em>No data available yet.</em></p>
        {% endif %}
        {% endwith %}

        <p class="text-muted mt-3 small">
          <i class="bi bi-clock-history"></i> Profiled {{ profile.date_profiled|timesince }} ago
        </p>
      </div>
    </div>
    {% endfor %}
  </div>



  {% else %}
  <div class="alert alert-warning text-center">No profiles found for this user.</div>
  {% endif %}

  <!-- Navigation -->
  <div class="text-center mt-5">
    <a href="{% url 'search_profile' %}" class="btn btn-outline-secondary mx-2">
      <i class="bi bi-arrow-left"></i> Back to Search
    </a>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  new Chart(document.getElementById("platformChart"), {
    type: "pie",
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        data: {{ chart_data|safe }},
        backgroundColor: ["#22267c", "#6f42c1", "#198754", "#dc3545", "#fd7e14", "#20c997"]
      }]
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } }
  });

  new Chart(document.getElementById("followersBarChart"), {
    type: "bar",
    data: {
      labels: {{ bar_labels|safe }},
      datasets: [{
        label: "Followers",
        data: {{ bar_data|safe }},
        backgroundColor: ["#1DA1F2", "#E1306C", "#69C9D0", "#333"]
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  new Chart(document.getElementById("growthLineChart"), {
    type: "line",
    data: {
      labels: {{ growth_labels|safe }},
      datasets: [{
        label: "Profiles Collected",
        data: {{ growth_data|safe }},
        fill: false,
        borderColor: "#22267c",
        tension: 0.3,
        pointBackgroundColor: "#f6c100"
      }]
    },
    options: { responsive: true, plugins: { legend: { position: "top" } } }
  });
</script>

{% endblock %}
