{% extends "pages/base.html" %}
{% load profile_extras %}

{% block title %}Dashboard | People Profiling{% endblock %}
{% block content %}

<style>
  body {
    background-color: #fdffff;
    font-family: 'Roboto', sans-serif;
  }

  /* Header */
  .profile-header {
    background: linear-gradient(135deg, #22267c, #3439a7);
    color: #fff;
    text-align: center;
    padding: 3rem 1rem;
    border-radius: 20px;
    margin-bottom: 2.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }
  .profile-header img {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    border: 5px solid #fff;
    object-fit: cover;
    margin-bottom: 1rem;
  }

  /* Section Headings */
  .section-title {
    font-weight: 700;
    color: #22267c;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  /* Cards */
  .card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    transition: transform 0.25s ease;
  }
  .card:hover {
    transform: translateY(-5px);
  }

  /* Badges */
  .badge-stat {
    font-size: 0.9rem;
    padding: 0.6rem 0.9rem;
    border-radius: 30px;
    margin: 0.25rem;
  }

  /* Buttons */
  .btn-outline-info {
    border-color: #22267c;
    color: #22267c;
  }
  .btn-outline-info:hover {
    background-color: #22267c;
    color: #fff;
  }

  /* Sherlock Results */
  .sherlock-results a.badge {
    background-color: #22267c;
    color: #fff;
    border-radius: 25px;
    transition: 0.3s;
  }
  .sherlock-results a.badge:hover {
    background-color: #f6c100;
    color: #222;
    transform: translateY(-3px);
  }

  /* Chart Headers */
  .card-header {
    border-top-left-radius: 20px !important;
    border-top-right-radius: 20px !important;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
</style>

<div class="container py-5">

{% if profiles %}
  <!-- Header -->
  <div class="profile-header mx-auto" style="max-width: 680px;">
    {% if profiles.0.avatar_url %}
      <img src="{{ profiles.0.avatar_url }}" alt="User Avatar">
    {% else %}
      <img src="https://via.placeholder.com/130" alt="No Avatar">
    {% endif %}
    <h2 class="fw-bold mb-1">Dashboard for {{ profiles.0.username }}</h2>
    <p class="text-light mb-0">Multi-platform social insights and behavioral analysis</p>
  </div>

  {% if not profiles.0.full_name and not profiles.0.socialmediaaccount_set.exists %}
  <div class="alert alert-info text-center mt-3 shadow-sm">
    <i class="bi bi-hourglass-split"></i>
    Data is being collected. Refreshing every 10 seconds...
  </div>
  <script>
    setTimeout(() => location.reload(), 10000);
  </script>
  {% endif %}

  <!-- Profile Details -->
  <h3 class="section-title">Profile Details</h3>
  <div class="row justify-content-center g-4">
    {% for profile in profiles %}
    <div class="col-md-6 col-lg-5">
      <div class="card p-4 h-100">
        <h5 class="fw-bold text-primary mb-2">
          <i class="bi bi-person-badge"></i> {{ profile.platform }} Profile
        </h5>
        <hr>
        <p><strong>Full Name:</strong> {{ profile.full_name|default:"Not available" }}</p>

        {% with accounts|get_account_for:profile as account %}
          {% if profile.platform == 'GitHub' and account %}
            <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
              <span class="badge bg-success badge-stat">Repos: {{ account.public_repos }}</span>
            </div>
            <p class="mt-3"><strong>Company:</strong> {{ profile.company|default:"Not specified" }}</p>
            <p><strong>Location:</strong> {{ profile.location|default:"Not specified" }}</p>
            <p><strong>Website:</strong>
              {% if profile.blog %}
                <a href="{{ profile.blog }}" target="_blank">{{ profile.blog }}</a>
              {% else %} Not specified {% endif %}
            </p>
            <p><strong>GitHub Joined:</strong> {{ profile.github_created_at|date:"F Y" }}</p>

            <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}" class="btn btn-outline-info btn-sm mt-3">
              <i class="bi bi-graph-up"></i> View Behavioral Dashboard
            </a>

          {% elif profile.platform == 'Twitter' and account %}
            <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
            </div>
            <p class="mt-3"><strong>Verified:</strong> {{ profile.verified|yesno:"Yes,No" }}</p>
            <p><strong>Location:</strong> {{ profile.location|default:"Not specified" }}</p>
            <p><strong>Twitter Joined:</strong> {{ profile.profile_created_at|date:"F Y" }}</p>

            <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}" class="btn btn-outline-info btn-sm mt-3">
              <i class="bi bi-graph-up"></i> View Behavioral Dashboard
            </a>

          {% elif profile.platform == 'Instagram' and account %}
            <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
              <span class="badge bg-success badge-stat">Posts: {{ account.posts_collected }}</span>
            </div>
            <p class="mt-3"><strong>Verified:</strong> {{ account.is_verified|yesno:"Yes,No" }}</p>

            <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}" class="btn btn-outline-info btn-sm mt-3">
              <i class="bi bi-graph-up"></i> View Behavioral Dashboard
            </a>

          {% elif profile.platform == 'TikTok' and account %}
            <p><strong>Bio:</strong> {{ account.bio|default:"No bio provided" }}</p>
            <div>
              <span class="badge bg-primary badge-stat">Followers: {{ account.followers }}</span>
              <span class="badge bg-secondary badge-stat">Following: {{ account.following }}</span>
              <span class="badge bg-success badge-stat">Videos: {{ account.videos }}</span>
              <span class="badge bg-warning badge-stat">Likes: {{ account.hearts }}</span>
            </div>

            <a href="{% url 'behavioral_dashboard' profile.username profile.platform %}" class="btn btn-outline-info btn-sm mt-3">
              <i class="bi bi-graph-up"></i> View Behavioral Dashboard
            </a>

          {% elif profile.platform == 'Sherlock' %}
            <h5 class="mt-3 text-primary"><i class="bi bi-search"></i> Results Found</h5>
            {% if request.session.sherlock_results %}
              <div class="sherlock-results d-flex flex-wrap gap-2 mt-3 justify-content-center">
                {% for result in request.session.sherlock_results %}
                  <a href="{{ result.url }}" target="_blank" class="badge text-decoration-none p-2">
                    {{ result.platform }}
                  </a>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mt-3"><em>No results available yet.</em></p>
            {% endif %}
          {% endif %}
        {% endwith %}

        <p class="text-muted mt-3 small">
          <i class="bi bi-clock-history"></i> Profiled {{ profile.date_profiled|timesince }} ago
        </p>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Analytics Section -->
  <h3 class="section-title mt-5">Analytics Overview</h3>
  <div class="row g-4">
    {% if wordcloud_image %}
    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white text-center">
          <i class="bi bi-cloud"></i> Word Cloud
        </div>
        <div class="card-body d-flex justify-content-center align-items-center" style="background:#f9fafc;">
          <img src="data:image/png;base64,{{ wordcloud_image }}" alt="Word Cloud"
               class="img-fluid rounded border p-1 shadow-sm" style="max-height:180px;">
        </div>
      </div>
    </div>
    {% endif %}

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white text-center">
          <i class="bi bi-pie-chart"></i> Platforms
        </div>
        <div class="card-body p-2">
          <canvas id="platformChart" height="180"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-info text-white text-center">
          <i class="bi bi-bar-chart"></i> Followers
        </div>
        <div class="card-body p-2">
          <canvas id="followersBarChart" height="180"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-warning text-dark text-center">
          <i class="bi bi-graph-up"></i> Growth
        </div>
        <div class="card-body p-2">
          <canvas id="growthLineChart" height="180"></canvas>
        </div>
      </div>
    </div>
  </div>

{% else %}
  <div class="alert alert-warning text-center">No profiles found for this user.</div>
{% endif %}

<!-- Navigation Buttons -->
<div class="text-center mt-5">
  <a href="{% url 'search_profile' %}" class="btn btn-outline-secondary mx-2">
    <i class="bi bi-arrow-left"></i> Back to Search
  </a>
  {% if profiles %}
  <a href="{% url 'profile_activity' profiles.0.pk %}" class="btn btn-primary mx-2">
    <i class="bi bi-graph-up"></i> View Activity
  </a>
  {% endif %}
</div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  new Chart(document.getElementById("platformChart"), {
    type: "pie",
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        data: {{ chart_data|safe }},
        backgroundColor: ["#22267c", "#6f42c1", "#198754", "#dc3545", "#fd7e14", "#20c997"]
      }]
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } }
  });

  new Chart(document.getElementById("followersBarChart"), {
    type: "bar",
    data: {
      labels: {{ bar_labels|safe }},
      datasets: [{
        label: "Followers",
        data: {{ bar_data|safe }},
        backgroundColor: ["#1DA1F2", "#E1306C", "#69C9D0", "#333"]
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  new Chart(document.getElementById("growthLineChart"), {
    type: "line",
    data: {
      labels: {{ growth_labels|safe }},
      datasets: [{
        label: "Profiles Collected",
        data: {{ growth_data|safe }},
        fill: false,
        borderColor: "#22267c",
        tension: 0.3,
        pointBackgroundColor: "#f6c100"
      }]
    },
    options: { responsive: true, plugins: { legend: { position: "top" } } }
  });
</script>

{% endblock %}
